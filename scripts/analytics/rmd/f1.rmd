---
title: "Block Processing Report"
date: "`r Sys.Date()`"
params:
  db: /var/opera/Aida/tmp-rapolt/register/s5-f1-test.db
---

```{r, include = FALSE}
library(ggplot2)
library(dplyr)
library(RSQLite)
library(gt)

# open database
con <- dbConnect(SQLite(), params$db)

# Fetch RunMetadata
Metadata <- dbReadTable(con, 'metadata')

first <- Metadata %>% filter(key == "First")
last <- Metadata %>% filter(key == "Last")

# load block and transaction tables into data frames and exclude lachesis transition block
TxData <- dbReadTable(con, 'stats') %>% filter(start >= as.integer(first$value) & end <= as.integer(last$value))

# close database connection
dbDisconnect(con)
```

## ##############################################################################

## 1. Summary

```{r, echo=FALSE, message=FALSE}
maxMemory <- TxData %>% filter(memory == max(memory)) %>% distinct(memory, start) 
maxLiveDisk <- TxData %>% filter(live_disk == max(live_disk)) %>% distinct(live_disk, start) 
maxArchiveDisk <- TxData %>% filter(archive_disk == max(archive_disk)) %>% distinct(archive_disk, start) 
maxTxRate <- TxData %>% filter(tx_rate == max(tx_rate)) %>% distinct(tx_rate, start)
maxGasRate <- TxData %>% filter(gas_rate == max(gas_rate)) %>% distinct(gas_rate, start) 

Property <- c("Memory", "Disk - LiveDb", "Disk - ArchiveDb", "Transaction Rate", "Gas Rate")
Unit <- c("Gb", "Gb", "Gb", "TPS", "GPS")
Conv <- c(1e-9, 1e-9, 1e-9, 1, 1)
Mean <- c(mean(TxData$memory), mean(TxData$live_disk), mean(TxData$archive_disk), mean(TxData$tx_rate), mean(TxData$gas_rate))
Max <- c(max(TxData$memory), max(TxData$live_disk), max(TxData$archive_disk), max(TxData$tx_rate), max(TxData$gas_rate))

summary <- data.frame(Property, Mean, Max) %>% 
	mutate(Mean = as.numeric(Mean) * as.numeric(Conv), Max = as.numeric(Max) * as.numeric(Conv)) %>%
	mutate(Mean = paste(Mean, Unit), Max = paste(Max, Unit))

gt(summary)
```


## ##############################################################################

```{r, echo=FALSE, message=FALSE}
hostname <- Metadata %>% filter(key == "Hostname")
ip <- Metadata %>% filter(key == "IpAddress")
processor <- Metadata %>% filter(key == "Processor")
memory <- Metadata %>% filter(key == "Memory")
disks <- Metadata %>% filter(key == "Disks")
OsInfo <- Metadata %>% filter(key == "Os")
GoInfo <- Metadata %>% filter(key == "GoVersion")
aidaHash <- Metadata %>% filter(key == "AidaGitHash")
carmenHash <- Metadata %>% filter(key == "CarmenGitHash")
dbImpl <- Metadata %>% filter(key == "DbImpl")
dbVariant <- Metadata %>% filter(key == "DbVariant")
carmenSchema <- Metadata %>% filter(key == "CarmenSchema")
vmImpl <- Metadata %>% filter(key == "VmImpl")
```

## 2. Experimental Setup
The experiment is run on the machine **`r hostname$value`**(**`r ip$value`**), which is a **`r processor$value`**, **`r memory$value`** computer.
The operating system is **`r OsInfo$value`**.
The system has installed **`r GoInfo$value`**.

The github hash of the libraries are:

* Aida: **`r aidaHash$value`**
* Carmen: **`r carmenHash$value`**

For this experiment, we use **`r dbImpl$value`**(**`r dbVariant$value`** **`r carmenSchema$value`**) as a StateDB and **`r vmImpl$value`** as a virtual machine.  The data set for this experiment is stored in the database **`r params$db`**.

## ##############################################################################

## 3. Memory and Disk Usage


The experiment was conducted for the block range from **`r format(min(TxData$start),big.mark=",")`**  to **`r format(max(TxData$end),big.mark=",")`**.

Max RAM Usage throughout the run is **`r format(maxMemory$memory, big.mark=",")`** bytes at block height **`r format(maxMemory$start, big.mark=",")`**. 

```{r, echo=FALSE, message=FALSE, fig.width=12, fig.height=8}
TxData %>% mutate(memory = as.numeric(memory)) %>%
   ggplot(aes(x = start, y = memory)) +
   geom_point(alpha=0.3) +
   labs(x="Block Height", y="Ram Consumption (Bytes)", title="Memory Usage")
```

Max Disk Usage throughout the run is **`r format(maxLiveDisk$live_disk, big.mark=",")`** bytes at block height **`r format(maxLiveDisk$start, big.mark=",")`**

```{r, echo=FALSE, message=FALSE, fig.width=12, fig.height=8}
TxData %>% mutate(live_disk = as.numeric(live_disk)) %>%
   ggplot(aes(x = start, y = live_disk)) +
   geom_point(alpha=0.3) +
   labs(x="Block Height", y="Disk Consumption (Bytes)", title="Disk Usage")
```

## ##############################################################################

## 4. Transaction Rate

The average transaction rate is **`r format(mean(TxData$tx_rate), big.mark=",")`** TPS. The max transaction rate  is **`r format(maxTxRate$tx_rate, big.mark=",")`** TPM at block height **`r format(maxTxRate$start, big.mark=",")`**. 

The dashed line shows the average transaction rate achieve up until the block height.

```{r, echo=FALSE, message=FALSE, fig.width=12, fig.height=8}
TxData %>% mutate(tx_rate = as.numeric(tx_rate)) %>%
   ggplot(aes(x = start, y = tx_rate)) +
   geom_line(aes(x = start, y = overall_tx_rate), linetype = "longdash", color = "tomato") +
   geom_point(alpha=0.3) +
   labs(x="Block Height", y="Transaction Per Minute", title="Transaction Rate")
```

## ##############################################################################

## 5. Gas Rate

The average gas rate is **`r format(mean(TxData$gas_rate), big.mark=",")`** GPS. The max gas rate  is **`r format(maxGasRate$gas_rate, big.mark=",")`** GPS at block height **`r format(maxGasRate$start, big.mark=",")`**. 

The dashed line shows the average gas rate achieve up until the block height.

```{r, echo=FALSE, message=FALSE, fig.width=12, fig.height=8}
TxData %>% mutate(gas_rate = as.numeric(gas_rate)) %>%
   ggplot(aes(x = start, y = gas_rate)) +
   geom_line(aes(x = start, y = overall_gas_rate), linetype = "longdash", color = "tomato") +
   geom_point(alpha=0.3) +
   labs(x="Block Height", y="Gas Per Minute", title="Gas Rate")
```

